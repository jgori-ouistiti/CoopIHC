<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>coopihc.base.State &mdash; CoopIHC 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> CoopIHC
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/more_complex_example.html">More Complex Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/modularity.html">Modularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/learning.html">Using Reinforcement Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/realuser.html">Interfacing CoopIHC with a real user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/simulating_rollouts.html">Assistants that simulate users</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/interaction_model.html">The Interaction Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/space.html">Space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/stateelement.html">StateElement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/state.html">State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/tasks.html">Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/agents.html">Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/policy.html">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/observation_engine.html">The Observation Engines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/inference_engine.html">The Inference Engines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/bundles.html">Bundles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/user_modeling.html">User Modeling Facilitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/wrappers.html">Wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/repository.html">Task and Agent Repository</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">See also</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">    Home page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/coopihc.html">    API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide/terminology.html">Terminology</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CoopIHC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>coopihc.base.State</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for coopihc.base.State</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">from</span> <span class="nn">coopihc.base.StateElement</span> <span class="kn">import</span> <span class="n">StateElement</span>
<span class="kn">from</span> <span class="nn">coopihc.base.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NotKnownSerializationWarning</span><span class="p">,</span>
    <span class="n">StateElementAssignmentWarning</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">coopihc.base.Space</span> <span class="kn">import</span> <span class="n">CatSet</span>


<div class="viewcode-block" id="State"><a class="viewcode-back" href="../../../_autosummary/coopihc.base.State.State.html#coopihc.base.State.State">[docs]</a><span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;State</span>

<span class="sd">    The container class for States. State subclasses dictionnary and adds a few methods:</span>

<span class="sd">        * reset(dic = reset_dic), which passes reset values to the StateElements it holds and triggers their reset method</span>
<span class="sd">        * filter(mode=mode, filterdict=filterdict), which filters out the state to extract some information.</span>
<span class="sd">        * serialize(), which transforms the state into a format that can be serializable, e.g. to send as a JSON format.</span>

<span class="sd">    Initializing a State is straightforward:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        state = State()</span>
<span class="sd">        substate = State()</span>
<span class="sd">        substate[&quot;x1&quot;] = discrete_array_element(init=1, low=1, high=3)</span>
<span class="sd">        substate[&quot;x3&quot;] = array_element(</span>
<span class="sd">            init=1.5 * numpy.ones((2, 2)), low=numpy.ones((2, 2)), high=2 * numpy.ones((2, 2))</span>
<span class="sd">        )</span>

<span class="sd">        substate2 = State()</span>
<span class="sd">        substate2[&quot;y1&quot;] = discrete_array_element(init=1, low=1, high=3)</span>

<span class="sd">        state[&quot;sub1&quot;] = substate</span>
<span class="sd">        state[&quot;sub2&quot;] = substate2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;__eq__</span>

<span class="sd">        equality checks on arrays (soft) Ã  la Numpy</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            _example_state = example_game_state()</span>
<span class="sd">            obs = {</span>
<span class="sd">                &quot;game_info&quot;: {&quot;turn_index&quot;: numpy.array(0), &quot;round_index&quot;: numpy.array(0)},</span>
<span class="sd">                &quot;task_state&quot;: {&quot;position&quot;: numpy.array(2), &quot;targets&quot;: numpy.array([0, 1])},</span>
<span class="sd">                &quot;user_action&quot;: {&quot;action&quot;: numpy.array(0)},</span>
<span class="sd">                &quot;assistant_action&quot;: {&quot;action&quot;: numpy.array(2)},</span>
<span class="sd">            }</span>
<span class="sd">            del _example_state[&quot;user_state&quot;]</span>
<span class="sd">            del _example_state[&quot;assistant_state&quot;]</span>
<span class="sd">            assert _example_state == obs</span>
<span class="sd">            assert _example_state.equals(obs, mode=&quot;soft&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;soft&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="State.equals"><a class="viewcode-back" href="../../../_autosummary/coopihc.base.State.State.html#coopihc.base.State.State.equals">[docs]</a>    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;hard&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;equals</span>

<span class="sd">        equality checks that also checks for spaces (hard).</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            _example_state = example_game_state()</span>
<span class="sd">            obs = {</span>
<span class="sd">                &quot;game_info&quot;: {&quot;turn_index&quot;: numpy.array(0), &quot;round_index&quot;: numpy.array(0)},</span>
<span class="sd">                &quot;task_state&quot;: {&quot;position&quot;: numpy.array(2), &quot;targets&quot;: numpy.array([0, 1])},</span>
<span class="sd">                &quot;user_action&quot;: {&quot;action&quot;: numpy.array(0)},</span>
<span class="sd">                &quot;assistant_action&quot;: {&quot;action&quot;: numpy.array(2)},</span>
<span class="sd">            }</span>
<span class="sd">            del _example_state[&quot;user_state&quot;]</span>
<span class="sd">            del _example_state[&quot;assistant_state&quot;]</span>
<span class="sd">            assert not _example_state.equals(obs, mode=&quot;hard&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="p">(</span><span class="n">okey</span><span class="p">,</span> <span class="n">ovalue</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">ovalue</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="n">cond</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">cond</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">okey</span> <span class="ow">and</span> <span class="n">cond</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">State</span><span class="p">,</span> <span class="n">StateElement</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StateElement</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">space</span> <span class="o">!=</span> <span class="n">value</span><span class="o">.</span><span class="n">space</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="n">StateElementAssignmentWarning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;You are trying to assign StateElement </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> with space </span><span class="si">{</span><span class="n">value</span><span class="o">.</span><span class="n">space</span><span class="si">}</span><span class="s2"> to a state which has previous StateElement </span><span class="si">{</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2"> with space </span><span class="si">{</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">space</span><span class="si">}</span><span class="s2">. To suppress this warning, either make sure your assignment is not of type StateElement, or delete the old statelement beforehand if you want it to be replaced&quot;</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="State.reset"><a class="viewcode-back" href="../../../_autosummary/coopihc.base.State.State.html#coopihc.base.State.State.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dic</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the state. See StateElement</span>

<span class="sd">        Example usage:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # Normal reset</span>
<span class="sd">            state.reset()</span>


<span class="sd">            # Forced reset</span>
<span class="sd">            reset_dic = {</span>
<span class="sd">                &quot;sub1&quot;: {&quot;x1&quot;: 3},</span>
<span class="sd">                &quot;sub2&quot;: {&quot;y1&quot;: 3},</span>
<span class="sd">            }</span>
<span class="sd">            state.reset(dic=reset_dic)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">reset_dic</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">value</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">reset_dic</span><span class="p">)</span></div>

<div class="viewcode-block" id="State.filter"><a class="viewcode-back" href="../../../_autosummary/coopihc.base.State.State.html#coopihc.base.State.State.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="n">filterdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract some part of the state information</span>

<span class="sd">        An example for filterdict&#39;s structure is as follows:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            filterdict = dict(</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;sub1&quot;: dict({&quot;x1&quot;: 0, &quot;x3&quot;: slice(0, 1)}),</span>
<span class="sd">                    &quot;sub2&quot;: dict({&quot;y1&quot;: 0}),</span>
<span class="sd">                }</span>
<span class="sd">            )</span>

<span class="sd">        This will filter out</span>

<span class="sd">            * the first component (index 0) for subsubstate x1 in substate sub1,</span>
<span class="sd">            * the first and second components for subsubstate x3 in substate sub1,</span>
<span class="sd">            * the first component for subsubstate y1 in substate sub2.</span>


<span class="sd">        Example usage:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # Filter out spaces</span>
<span class="sd">            f_state = state.filter(mode=&quot;space&quot;, filterdict=filterdict)</span>

<span class="sd">            # Filter out as arrays</span>
<span class="sd">            f_state = state.filter(mode=&quot;array&quot;, filterdict=filterdict)</span>

<span class="sd">            # Filter out as StateElement</span>
<span class="sd">            f_state = state.filter(mode=&quot;stateelement&quot;, filterdict=filterdict)</span>

<span class="sd">            # Get spaces</span>
<span class="sd">            f_state = state.filter(mode=&quot;space&quot;)</span>

<span class="sd">            # Get arrays</span>
<span class="sd">            f_state = state.filter(mode=&quot;array&quot;)</span>

<span class="sd">            # Get Gym Compatible arrays</span>
<span class="sd">            f_state = state.filter(mode=&quot;array-Gym&quot;)</span>


<span class="sd">        :param mode: &quot;array&quot; or &quot;spaces&quot; or &quot;stateelement&quot;, defaults to &quot;array&quot;. If &quot;stateelement&quot;, returns a dictionnary with the selected stateelements. If &quot;spaces&quot;, returns the same dictionnary, but with only the spaces (no array information). If &quot;array&quot;, returns the same dictionnary, but with only the value arrays (no space information).</span>
<span class="sd">        :type mode: str, optional</span>
<span class="sd">        :param filterdict: the dictionnary that indicates which components to filter out, defaults to None</span>
<span class="sd">        :type filterdict: dictionnary, optional</span>
<span class="sd">        :return: The dictionnary with the filtered state</span>
<span class="sd">        :rtype: dictionnary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">filterdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filterdict</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filterdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">State</span><span class="p">):</span>
                <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">filterdict</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">StateElement</span><span class="p">):</span>
                <span class="c1"># to make S.filter(&quot;values&quot;, S) possible.</span>
                <span class="c1"># Warning: values == filterdict[key] != self[key]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StateElement</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># Deal with 0-D arrays</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ellipsis  # slice(0, 1, 1)</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;space&quot;</span><span class="p">:</span>
                    <span class="n">_SEspace</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">space</span>
                    <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SEspace</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
                    <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;array-Gym&quot;</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">space</span><span class="p">,</span> <span class="n">CatSet</span><span class="p">):</span>
                        <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
                        <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stateelement&quot;</span><span class="p">:</span>
                    <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">value</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;space&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">new_state</span></div>

    <span class="k">def</span> <span class="nf">__content__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Here we override copy and deepcopy simply because there seems to be some overhead in the default deepcopy implementation. It turns out the gain is almost None, but keep it here as a reminder that deepcopy needs speeding up.  Adapted from StateElement code</span>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">copy_object</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">copy_object</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">copy_object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">copy_object</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memodict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">deepcopy_object</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">memodict</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="n">deepcopy_object</span>
        <span class="n">deepcopy_object</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">deepcopy_object</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">memodict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deepcopy_object</span>

<div class="viewcode-block" id="State.serialize"><a class="viewcode-back" href="../../../_autosummary/coopihc.base.State.State.html#coopihc.base.State.State.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes the state serializable.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            state.serialize()</span>

<span class="sd">        :return: serializable dictionnary</span>
<span class="sd">        :rtype: dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value_</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value_</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warns</span><span class="p">(</span>
                        <span class="n">NotKnownSerializationWarning</span><span class="p">(</span>
                            <span class="s2">&quot;warning: I don&#39;t know how to serialize </span><span class="si">{}</span><span class="s2">. I&#39;m sending the whole internal dictionnary of the object. Consider adding a serialize() method to your custom object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">value</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">value_</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="n">ret_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_</span>
        <span class="k">return</span> <span class="n">ret_dict</span></div>

    <span class="k">def</span> <span class="nf">_tabulate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;_tabulate</span>

<span class="sd">        See __str__ for usage</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line_no</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">tab</span><span class="p">,</span> <span class="n">tablines</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_tabulate</span><span class="p">()</span>

            <span class="n">nline</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># deal with empty substates</span>

            <span class="k">for</span> <span class="n">nline</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tab</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">State</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nline</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
                <span class="n">line</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span>
            <span class="n">line_no</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">line_no</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tabulate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tabulate</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Julien Gori.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>